# æ•°æ®æ±‡æ€»æœåŠ¡ (Data Summary Service)

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„å®šæ—¶ä»»åŠ¡æœåŠ¡ï¼Œç”¨äºæ±‡æ€»æ•°æ®åº“è¡¨æ•°æ®å¹¶ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSSã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **å®šæ—¶ä»»åŠ¡è°ƒåº¦**ï¼šæ”¯æŒçµæ´»çš„cronè¡¨è¾¾å¼é…ç½®
- **å¤šè¡¨æ•°æ®æ±‡æ€»**ï¼šå¯é…ç½®å¤šå¼ è¡¨çš„æ•°æ®æŸ¥è¯¢å’Œæ±‡æ€»
- **å¤šæ ¼å¼å¯¼å‡º**ï¼šæ”¯æŒJSONå’ŒExcelæ ¼å¼æ•°æ®å¯¼å‡º
- **é˜¿é‡Œäº‘OSSé›†æˆ**ï¼šè‡ªåŠ¨ä¸Šä¼ æ±‡æ€»ç»“æœåˆ°OSS
- **å®Œæ•´æ—¥å¿—ç³»ç»Ÿ**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œé”™è¯¯è¿½è¸ª
- **ä¼˜é›…å…³é—­**ï¼šæ”¯æŒå®‰å…¨çš„æœåŠ¡å…³é—­å’Œèµ„æºæ¸…ç†
- **ç¯å¢ƒé…ç½®**ï¼šå®Œå–„çš„ç¯å¢ƒå˜é‡é…ç½®ç®¡ç†

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
data-summary-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js                    # ä¸»åº”ç”¨ç¨‹åº
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.js           # æ•°æ®åº“é…ç½®å’Œè¿æ¥
â”‚   â”‚   â””â”€â”€ oss.js               # OSSé…ç½®å’ŒæœåŠ¡
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ dataSummaryService.js # æ•°æ®æ±‡æ€»æ ¸å¿ƒæœåŠ¡
â”‚   â”‚   â””â”€â”€ schedulerService.js   # å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ logger.js            # æ—¥å¿—å·¥å…·
â”œâ”€â”€ logs/                        # æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ temp/                        # ä¸´æ—¶æ–‡ä»¶ç›®å½•
â”œâ”€â”€ exports/                     # å¯¼å‡ºæ–‡ä»¶ç›®å½•
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ package.json                 # é¡¹ç›®ä¾èµ–é…ç½®
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸ› ï¸ å®‰è£…å’Œé…ç½®

### 1. å®‰è£…ä¾èµ–

```bash
cd data-summary-service
npm install
```

### 2. ç¯å¢ƒé…ç½®

å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=your_database

# é˜¿é‡Œäº‘OSSé…ç½®
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET=your_bucket_name

# å®šæ—¶ä»»åŠ¡é…ç½®
CRON_SCHEDULE=0 2 * * *

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FILE=logs/app.log
```

### 3. æ•°æ®åº“è¡¨é…ç½®

åœ¨ `src/services/dataSummaryService.js` ä¸­é…ç½®éœ€è¦æ±‡æ€»çš„è¡¨ï¼š

```javascript
this.tableConfigs = [
  {
    name: 'users',
    query: 'SELECT * FROM users WHERE created_at >= ? AND created_at < ?',
    filename: 'users_summary'
  },
  {
    name: 'orders',
    query: 'SELECT * FROM orders WHERE order_date >= ? AND order_date < ?',
    filename: 'orders_summary'
  }
  // æ·»åŠ æ›´å¤šè¡¨é…ç½®...
];
```

## ğŸš€ è¿è¡ŒæœåŠ¡

### å¼€å‘æ¨¡å¼
```bash
npm run dev
```

### ç”Ÿäº§æ¨¡å¼
```bash
npm start
```

## ğŸ“… å®šæ—¶ä»»åŠ¡é…ç½®

æœåŠ¡é»˜è®¤åŒ…å«ä»¥ä¸‹å®šæ—¶ä»»åŠ¡ï¼š

- **æ¯æ—¥æ±‡æ€»**ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ (`0 2 * * *`)
- **æ¯å‘¨æ±‡æ€»**ï¼šæ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹æ‰§è¡Œ (`0 3 * * 1`)
- **æ¯æœˆæ±‡æ€»**ï¼šæ¯æœˆ1å·å‡Œæ™¨4ç‚¹æ‰§è¡Œ (`0 4 1 * *`)

### Cronè¡¨è¾¾å¼æ ¼å¼

```
* * * * *
â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€ æ˜ŸæœŸå‡  (0-7, 0å’Œ7éƒ½è¡¨ç¤ºæ˜ŸæœŸæ—¥)
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€ æœˆä»½ (1-12)
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
```

### å¸¸ç”¨Cronè¡¨è¾¾å¼ç¤ºä¾‹

- `0 2 * * *` - æ¯å¤©å‡Œæ™¨2ç‚¹
- `0 0 * * 0` - æ¯å‘¨æ—¥åˆå¤œ
- `0 0 1 * *` - æ¯æœˆ1å·åˆå¤œ
- `*/30 * * * *` - æ¯30åˆ†é’Ÿ
- `0 9-17 * * 1-5` - å·¥ä½œæ—¥9ç‚¹åˆ°17ç‚¹æ¯å°æ—¶

## ğŸ“Š æ•°æ®å¯¼å‡ºæ ¼å¼

### JSONæ ¼å¼
```json
{
  "data": [...],
  "count": 100,
  "queryTime": "2024-01-15 10:30:00"
}
```

### Excelæ ¼å¼
- æ¯ä¸ªè¡¨çš„æ•°æ®ä½œä¸ºå•ç‹¬çš„å·¥ä½œè¡¨
- åŒ…å«æ‰€æœ‰å­—æ®µå’Œè®°å½•
- è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³

## ğŸ“ OSSæ–‡ä»¶ç»„ç»‡ç»“æ„

```
your-bucket/
â”œâ”€â”€ data-summary/
â”‚   â”œâ”€â”€ daily/
â”‚   â”‚   â””â”€â”€ 2024-01-15/
â”‚   â”‚       â”œâ”€â”€ users_103000.json
â”‚   â”‚       â”œâ”€â”€ orders_103000.json
â”‚   â”‚       â”œâ”€â”€ summary_103000.xlsx
â”‚   â”‚       â””â”€â”€ report_103000.json
â”‚   â”œâ”€â”€ weekly/
â”‚   â”‚   â””â”€â”€ 2024-01-15/
â”‚   â””â”€â”€ monthly/
â”‚       â””â”€â”€ 2024-01-01/
â””â”€â”€ custom-queries/
    â”œâ”€â”€ special_report_20240115_103000.json
    â””â”€â”€ special_report_20240115_103000.xlsx
```

## ğŸ”§ APIä½¿ç”¨ç¤ºä¾‹

```javascript
const DataSummaryApp = require('./src/app');
const app = new DataSummaryApp();

// å¯åŠ¨æœåŠ¡
await app.start();

// æ‰‹åŠ¨æ‰§è¡Œæ±‡æ€»
const result = await app.executeManualSummary('daily');

// è·å–æœåŠ¡çŠ¶æ€
const status = app.getStatus();
```

## ğŸ“ æ—¥å¿—ç³»ç»Ÿ

æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š
- `logs/combined.log` - æ‰€æœ‰æ—¥å¿—
- `logs/error.log` - é”™è¯¯æ—¥å¿—

æ—¥å¿—çº§åˆ«ï¼š
- `error` - é”™è¯¯ä¿¡æ¯
- `warn` - è­¦å‘Šä¿¡æ¯
- `info` - ä¸€èˆ¬ä¿¡æ¯
- `debug` - è°ƒè¯•ä¿¡æ¯

## ğŸ” ç›‘æ§å’Œç»´æŠ¤

### æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/combined.log

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node
```

### å¸¸è§é—®é¢˜æ’æŸ¥

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
   - éªŒè¯è¿æ¥å‚æ•°æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **OSSä¸Šä¼ å¤±è´¥**
   - éªŒè¯OSSé…ç½®å‚æ•°
   - æ£€æŸ¥è®¿é—®æƒé™
   - ç¡®è®¤bucketå­˜åœ¨

3. **å®šæ—¶ä»»åŠ¡æœªæ‰§è¡Œ**
   - æ£€æŸ¥cronè¡¨è¾¾å¼æ ¼å¼
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—
   - éªŒè¯ç³»ç»Ÿæ—¶åŒºè®¾ç½®

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡å®‰å…¨**
   - ä¸è¦å°†`.env`æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
   - ä½¿ç”¨å¼ºå¯†ç å’Œå¤æ‚çš„è®¿é—®å¯†é’¥
   - å®šæœŸè½®æ¢è®¿é—®å¯†é’¥

2. **æ•°æ®åº“å®‰å…¨**
   - ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
   - å¯ç”¨SSLè¿æ¥
   - å®šæœŸå¤‡ä»½æ•°æ®

3. **OSSå®‰å…¨**
   - é…ç½®é€‚å½“çš„è®¿é—®ç­–ç•¥
   - å¯ç”¨è®¿é—®æ—¥å¿—
   - å®šæœŸæ£€æŸ¥å­˜å‚¨ä½¿ç”¨æƒ…å†µ

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ä¼˜åŒ–**
   - ä¸ºæŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
   - åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®

2. **å†…å­˜ä¼˜åŒ–**
   - åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡
   - ä½¿ç”¨æµå¼å¤„ç†å¤§æ–‡ä»¶
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

3. **ç½‘ç»œä¼˜åŒ–**
   - å¯ç”¨gzipå‹ç¼©
   - ä½¿ç”¨CDNåŠ é€Ÿ
   - åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- åˆ›å»º Issue
- å‘é€é‚®ä»¶è‡³ï¼šsupport@example.com

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªæ˜Ÿæ˜Ÿæ”¯æŒä¸€ä¸‹ï¼