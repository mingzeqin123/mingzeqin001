# 系统架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    定时任务汇总系统                          │
├─────────────────────────────────────────────────────────────┤
│  Web API层                                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 健康检查API  │ │ 手动触发API  │ │ 状态查询API  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  调度层                                                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              SchedulerService                          │ │
│  │  - Cron定时调度                                        │ │
│  │  - 任务状态管理                                        │ │
│  │  - 错误重试机制                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              DataAggregator                            │ │
│  │  - 多表数据汇总                                        │ │
│  │  - 聚合计算                                            │ │
│  │  - 多格式输出                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  数据访问层                                                  │
│  ┌─────────────────┐              ┌─────────────────┐       │
│  │ DatabaseService │              │   OSSService    │       │
│  │ - MySQL连接池   │              │ - 文件上传      │       │
│  │ - 查询优化      │              │ - 路径管理      │       │
│  │ - 事务管理      │              │ - 权限控制      │       │
│  └─────────────────┘              └─────────────────┘       │
├─────────────────────────────────────────────────────────────┤
│  外部服务                                                    │
│  ┌─────────────────┐              ┌─────────────────┐       │
│  │   MySQL数据库   │              │   阿里云OSS     │       │
│  │ - 用户表        │              │ - JSON文件      │       │
│  │ - 订单表        │              │ - CSV文件       │       │
│  │ - 产品表        │              │ - Excel文件     │       │
│  └─────────────────┘              └─────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. SchedulerService (调度服务)
- **职责**: 管理定时任务的执行
- **功能**:
  - 基于cron表达式的定时调度
  - 任务状态跟踪
  - 错误处理和重试
  - 并发控制

### 2. DataAggregator (数据汇总器)
- **职责**: 执行数据汇总和聚合
- **功能**:
  - 多表数据查询
  - 聚合计算 (COUNT, SUM, AVG等)
  - 多格式输出 (JSON, CSV, Excel)
  - 元数据生成

### 3. DatabaseService (数据库服务)
- **职责**: 管理数据库连接和查询
- **功能**:
  - 连接池管理
  - 查询优化
  - 事务处理
  - 错误重连

### 4. OSSService (OSS上传服务)
- **职责**: 管理文件上传到阿里云OSS
- **功能**:
  - 文件上传
  - 路径管理
  - 权限控制
  - 上传状态跟踪

## 数据流程

```
1. 定时触发
   ↓
2. 获取表配置
   ↓
3. 执行数据查询
   ↓
4. 数据聚合计算
   ↓
5. 生成输出文件
   ↓
6. 上传到OSS
   ↓
7. 清理临时文件
   ↓
8. 记录执行日志
```

## 配置管理

### 环境变量
- 数据库连接配置
- OSS访问配置
- 定时任务配置
- 日志级别配置

### 聚合配置
- 表级别聚合规则
- 字段选择配置
- 聚合函数配置
- 输出格式配置

## 错误处理

### 分层错误处理
1. **数据库层**: 连接错误、查询错误
2. **业务逻辑层**: 数据处理错误、格式转换错误
3. **上传层**: 网络错误、权限错误
4. **调度层**: 任务执行错误、重试机制

### 日志记录
- 结构化日志 (JSON格式)
- 分级日志 (ERROR, WARN, INFO, DEBUG)
- 文件轮转
- 错误堆栈跟踪

## 性能优化

### 数据库优化
- 连接池配置
- 查询优化
- 索引建议
- 批量处理

### 内存优化
- 流式处理大数据
- 及时释放资源
- 垃圾回收优化

### 网络优化
- 并发上传
- 压缩传输
- 超时控制

## 扩展性设计

### 水平扩展
- 无状态设计
- 负载均衡支持
- 容器化部署

### 功能扩展
- 插件化架构
- 自定义聚合器
- 多数据源支持

### 监控扩展
- 指标收集
- 告警机制
- 性能分析