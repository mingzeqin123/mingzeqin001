<!--pages/statistics/statistics.wxml-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="header">
    <text class="title">ğŸ“Š æ•°æ®ç»Ÿè®¡</text>
    <view class="header-actions">
      <button class="btn-icon" bindtap="exportStatistics">
        <text class="icon">ğŸ“¤</text>
      </button>
      <button class="btn-icon" bindtap="clearStatistics">
        <text class="icon">ğŸ—‘ï¸</text>
      </button>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ç»Ÿè®¡å†…å®¹ -->
  <view wx:else class="content">
    
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <view class="tabs">
      <view class="tab-item {{selectedTab === 'overview' ? 'active' : ''}}" 
            data-tab="overview" bindtap="onTabChange">
        <text>æ¦‚è§ˆ</text>
      </view>
      <view class="tab-item {{selectedTab === 'pages' ? 'active' : ''}}" 
            data-tab="pages" bindtap="onTabChange">
        <text>é¡µé¢</text>
      </view>
      <view class="tab-item {{selectedTab === 'trends' ? 'active' : ''}}" 
            data-tab="trends" bindtap="onTabChange">
        <text>è¶‹åŠ¿</text>
      </view>
      <view class="tab-item {{selectedTab === 'details' ? 'active' : ''}}" 
            data-tab="details" bindtap="onTabChange">
        <text>è¯¦æƒ…</text>
      </view>
    </view>

    <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
    <view wx:if="{{selectedTab === 'overview'}}" class="tab-content">
      
      <!-- ä»Šæ—¥ç»Ÿè®¡ -->
      <view class="section">
        <view class="section-title">ğŸ“… ä»Šæ—¥ç»Ÿè®¡ ({{todayStats.date}})</view>
        <view class="today-stats">
          <view class="today-item">
            <text class="label">ä»Šæ—¥PV</text>
            <text class="value pv-color">{{todayStats.pv}}</text>
          </view>
          <view class="today-item">
            <text class="label">ä»Šæ—¥UV</text>
            <text class="value uv-color">{{todayStats.uv}}</text>
          </view>
        </view>
      </view>

      <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
      <view class="section">
        <view class="section-title">ğŸ“ˆ æ€»ä½“ç»Ÿè®¡</view>
        <view class="stats-cards">
          <view class="stats-card pv-card">
            <view class="card-icon">ğŸ‘ï¸</view>
            <view class="card-content">
              <text class="card-title">æ€»é¡µé¢æµè§ˆé‡</text>
              <text class="card-value">{{stats.summary.totalPV}}</text>
              <text class="card-label">PV</text>
            </view>
          </view>
          
          <view class="stats-card uv-card">
            <view class="card-icon">ğŸ‘¤</view>
            <view class="card-content">
              <text class="card-title">æ€»ç‹¬ç«‹è®¿å®¢</text>
              <text class="card-value">{{stats.summary.totalUV}}</text>
              <text class="card-label">UV</text>
            </view>
          </view>
          
          <view class="stats-card active-card">
            <view class="card-icon">ğŸ”¥</view>
            <view class="card-content">
              <text class="card-title">æ´»è·ƒç”¨æˆ·</text>
              <text class="card-value">{{stats.uv.activeUsers}}</text>
              <text class="card-label">7å¤©å†…</text>
            </view>
          </view>
          
          <view class="stats-card avg-card">
            <view class="card-icon">ğŸ“Š</view>
            <view class="card-content">
              <text class="card-title">å¹³å‡è®¿é—®</text>
              <text class="card-value">{{stats.summary.avgPVPerUV}}</text>
              <text class="card-label">PV/UV</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å¿«é€Ÿè¶‹åŠ¿ -->
      <view class="section">
        <view class="section-title">ğŸ“ˆ 7å¤©è¶‹åŠ¿</view>
        <view class="quick-trend">
          <view wx:for="{{recentStats}}" wx:key="date" class="trend-item"
                data-index="{{index}}" bindtap="showTrendDetail">
            <text class="trend-date">{{item.date.substring(5)}}</text>
            <view class="trend-bars">
              <view class="trend-bar pv-bar" style="height: {{item.pv > 0 ? (item.pv / 20 * 100) : 5}}%"></view>
              <view class="trend-bar uv-bar" style="height: {{item.uv > 0 ? (item.uv / 10 * 100) : 5}}%"></view>
            </view>
            <text class="trend-values">{{item.pv}}/{{item.uv}}</text>
          </view>
        </view>
        <view class="trend-legend">
          <view class="legend-item">
            <view class="legend-color pv-color"></view>
            <text>PV</text>
          </view>
          <view class="legend-item">
            <view class="legend-color uv-color"></view>
            <text>UV</text>
          </view>
        </view>
      </view>
    </view>

    <!-- é¡µé¢ç»Ÿè®¡æ ‡ç­¾é¡µ -->
    <view wx:if="{{selectedTab === 'pages'}}" class="tab-content">
      <view class="section">
        <view class="section-title">ğŸ“„ é¡µé¢è®¿é—®æ’è¡Œ</view>
        <view class="page-list">
          <view wx:for="{{stats.pv.pages}}" wx:for-item="pv" wx:for-index="path" wx:key="path"
                class="page-item" data-path="{{path}}" bindtap="showPageDetail">
            <view class="page-info">
              <text class="page-name">{{formatPagePath ? formatPagePath(path) : path}}</text>
              <text class="page-path">{{path}}</text>
            </view>
            <view class="page-stats">
              <view class="stat-item">
                <text class="stat-label">PV</text>
                <text class="stat-value pv-color">{{pv}}</text>
              </view>
              <view class="stat-item">
                <text class="stat-label">UV</text>
                <text class="stat-value uv-color">{{stats.uv.pages[path] || 0}}</text>
              </view>
            </view>
            <text class="page-arrow">â€º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¶‹åŠ¿åˆ†ææ ‡ç­¾é¡µ -->
    <view wx:if="{{selectedTab === 'trends'}}" class="tab-content">
      <view class="section">
        <view class="section-title">ğŸ“ˆ è®¿é—®è¶‹åŠ¿åˆ†æ</view>
        
        <!-- è¶‹åŠ¿å›¾è¡¨åŒºåŸŸ -->
        <view class="chart-container">
          <view class="chart-header">
            <text class="chart-title">æœ€è¿‘7å¤©è®¿é—®è¶‹åŠ¿</text>
          </view>
          <view class="chart-area">
            <view class="chart-y-axis">
              <text class="y-label">è®¿é—®é‡</text>
            </view>
            <view class="chart-content">
              <view wx:for="{{recentStats}}" wx:key="date" class="chart-bar-group">
                <view class="chart-bars">
                  <view class="chart-bar pv-bar" 
                        style="height: {{item.pv > 0 ? Math.min(item.pv * 5, 100) : 2}}px"></view>
                  <view class="chart-bar uv-bar" 
                        style="height: {{item.uv > 0 ? Math.min(item.uv * 8, 100) : 2}}px"></view>
                </view>
                <text class="chart-label">{{item.date.substring(5)}}</text>
              </view>
            </view>
          </view>
          <view class="chart-legend">
            <view class="legend-item">
              <view class="legend-dot pv-color"></view>
              <text>é¡µé¢æµè§ˆé‡ (PV)</text>
            </view>
            <view class="legend-item">
              <view class="legend-dot uv-color"></view>
              <text>ç‹¬ç«‹è®¿å®¢ (UV)</text>
            </view>
          </view>
        </view>

        <!-- è¶‹åŠ¿æ•°æ®åˆ—è¡¨ -->
        <view class="trend-list">
          <view wx:for="{{recentStats}}" wx:key="date" class="trend-list-item"
                data-index="{{index}}" bindtap="showTrendDetail">
            <view class="trend-date-info">
              <text class="date">{{item.date}}</text>
              <text class="weekday">
                {{item.date === todayStats.date ? 'ä»Šå¤©' : ''}}
              </text>
            </view>
            <view class="trend-values">
              <view class="value-item">
                <text class="label">PV</text>
                <text class="value pv-color">{{item.pv}}</text>
              </view>
              <view class="value-item">
                <text class="label">UV</text>
                <text class="value uv-color">{{item.uv}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯¦ç»†ä¿¡æ¯æ ‡ç­¾é¡µ -->
    <view wx:if="{{selectedTab === 'details'}}" class="tab-content">
      <view class="section">
        <view class="section-title">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</view>
        
        <!-- æœ€è¿‘è®¿é—®è®°å½• -->
        <view class="detail-section">
          <text class="detail-title">æœ€è¿‘è®¿é—®è®°å½•</text>
          <view class="recent-records">
            <view wx:for="{{stats.pv.recentRecords}}" wx:key="index" class="record-item">
              <view class="record-info">
                <text class="record-page">{{formatPagePath ? formatPagePath(item.pagePath) : item.pagePath}}</text>
                <text class="record-time">{{new Date(item.timestamp).toLocaleString()}}</text>
              </view>
              <text class="record-user">{{item.userId.substring(0, 8)}}...</text>
            </view>
          </view>
        </view>

        <!-- æ•°æ®æ¦‚è¦ -->
        <view class="detail-section">
          <text class="detail-title">æ•°æ®æ¦‚è¦</text>
          <view class="data-summary">
            <view class="summary-row">
              <text class="summary-label">æ•°æ®ç»Ÿè®¡å¼€å§‹æ—¶é—´</text>
              <text class="summary-value">
                {{stats.pv.recentRecords.length > 0 ? new Date(stats.pv.recentRecords[stats.pv.recentRecords.length - 1].timestamp).toLocaleDateString() : 'æš‚æ— æ•°æ®'}}
              </text>
            </view>
            <view class="summary-row">
              <text class="summary-label">æ€»é¡µé¢æ•°</text>
              <text class="summary-value">{{Object.keys(stats.pv.pages).length}}</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">ç»Ÿè®¡å¤©æ•°</text>
              <text class="summary-value">{{Object.keys(stats.pv.daily).length}}</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">å¹³å‡æ—¥PV</text>
              <text class="summary-value">
                {{Object.keys(stats.pv.daily).length > 0 ? Math.round(stats.summary.totalPV / Object.keys(stats.pv.daily).length) : 0}}
              </text>
            </view>
            <view class="summary-row">
              <text class="summary-label">å¹³å‡æ—¥UV</text>
              <text class="summary-value">
                {{Object.keys(stats.uv.daily).length > 0 ? Math.round(stats.summary.totalUV / Object.keys(stats.uv.daily).length) : 0}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¯¼å‡ºå¼¹çª— -->
  <view wx:if="{{showExportModal}}" class="modal-overlay" bindtap="closeExportModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">å¯¼å‡ºç»Ÿè®¡æ•°æ®</text>
        <button class="modal-close" bindtap="closeExportModal">Ã—</button>
      </view>
      <view class="modal-body">
        <text class="modal-desc">é€‰æ‹©å¯¼å‡ºæ–¹å¼ï¼š</text>
        <view class="export-options">
          <button class="export-btn" bindtap="copyToClipboard">
            <text class="export-icon">ğŸ“‹</text>
            <text>å¤åˆ¶åˆ°å‰ªè´´æ¿</text>
          </button>
          <button class="export-btn" bindtap="shareStatistics">
            <text class="export-icon">ğŸ“¤</text>
            <text>åˆ†äº«æ•°æ®</text>
          </button>
        </view>
      </view>
    </view>
  </view>
</view>